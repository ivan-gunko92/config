#!/bin/bash
set -eu -o pipefail
set -f
#END

known_error() {
    echo "$1"
    exit 133
}

sync_in_folder() {
  local  dir="$1"
  echo "Sync in folder ${dir}"
  test -d "${dir}" || known_error "Directory not exist ${dir}!"
  cd "${dir}"
  test -z "$(git diff)" || known_error "There is not commited changes in \`${dir}\`!"
  git checkout master
  git fetch --all
  git rebase origin/master
  git push origin master
}

sync_in_folder_from_var() {
  local var_name="$1"
  echo "For enviroment: ${var_name}"
  var_val=$(eval "echo \"\$$var_name\"")
  echo "var_val: ${var_val}"
  test -n "${var_val}" || known_error "Enviroment variable \`${var_name}\` is not set or empty!"
  sync_in_folder "${var_val}"
}

for env_name in config tips PASSWORD_STORE_DIR ; do
  sync_in_folder_from_var "${env_name}"
done
